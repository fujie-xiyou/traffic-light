;南北东西时间正常
;使用存储器(变量)在过程调用之间传递参数
;将不闪烁的地方认为是使用相同的值在闪烁
;然后通过在过程 SHOW7SEG中使用两次 DELAY(每次0.5秒) 
;来实现闪烁


;8255 A，B，C口以及控制口的口地址
;应该根据实际的连线情况(cs接口)修改
APORT  EQU  0000H 
BPORT  EQU  0002H 
CPORT  EQU  0004H 
CTRLP  EQU  0006H

DATA SEGMENT

	;数码管字形代码(0-F)
	TAB DB 3FH, 06H, 5BH, 4FH, 66H, 6DH, 7DH, 07H, 7FH, 6FH
		DB 77H, 7CH, 39H, 5EH, 79H, 71H
	NS DW 0 ;控制南北方向的数码管从几开始倒计时
	EW DW 0 ;控制东西方向的数码管从几开始倒计时
	I  DW 0 ;控制本轮倒计时共进行几秒
	
	INIT DW 0 ;控制红绿灯不闪烁的情况下谁亮
	FLASH DW 0 ;控制某一绿灯闪烁
	FLASH_7SEG DW 0 ;控制数字闪烁 0代表不闪烁 大于0代表南北闪烁  小于0代表东西闪烁
DATA ENDS

STACK SEGMENT STACK
	DB 100 DUP(?)
STACK ENDS

CODE SEGMENT
    ASSUME CS:CODE,DS:DATA;,SS:STACK
	
START:
	MOV AX,STACK
	MOV SS,AX
	MOV AX,DATA
	MOV DS,AX
    MOV AL, 10000000B
    MOV DX, CTRLP
    OUT DX, AL
LPT:        
    MOV DX, APORT
	;-绿|红   -代表东西方向 | 代表南北方向  下同
    MOV INIT ,0AH ;东西方向绿灯亮 南北方向红灯亮
	MOV FLASH,0AH
	MOV FLASH_7SEG,0
	MOV NS,9
	MOV EW,6
	MOV I,3
	CALL SHOW7SEG

	;-绿闪|红
	MOV INIT ,0AH 
	MOV FLASH,08H
	MOV FLASH_7SEG,-1
	MOV NS,6
	MOV EW,3
	MOV I,3
	CALL SHOW7SEG

	;-黄|红
    MOV INIT ,09H
	MOV FLASH,09H
	MOV FLASH_7SEG,0
	MOV NS,3
	MOV EW,3
	MOV I,3
	CALL SHOW7SEG

	;-红|绿
    MOV INIT ,14H
	MOV FLASH,14H
	MOV FLASH_7SEG,0
	MOV NS,6
	MOV EW,9
	MOV I,3
	CALL SHOW7SEG
	
	;-红|绿闪
	MOV INIT ,14H
	MOV FLASH,04H
	MOV FLASH_7SEG,1
	MOV NS,3
	MOV EW,6
	MOV I,3
	CALL SHOW7SEG
	
	;-红|黄
    MOV INIT ,24H
	MOV FLASH,24H
	MOV FLASH_7SEG,0
	MOV NS,3
	MOV EW,3
	MOV I,3
	CALL SHOW7SEG
	
	JMP LPT

DELAY:
	PUSH BX
	PUSH CX
	PUSH DX
	MOV CX,2;调节此参数成倍改变停顿时间
LL:
	MOV BX,CX
	PUSH CX
	MOV CX,0CC00H ;内层循环次数 也可以用来调整间隔时间
LL2:
	NOP
	LOOP LL2
	POP CX
	LOOP LL
	POP DX
	POP CX
	POP BX
	RET
SHOW7SEG:
	PUSH BX
	PUSH CX
	PUSH DX
	PUSH BP
	
	MOV CX,I
	MOV BX,NS
	MOV BP,EW
LOOPS:
;前半秒红绿灯以及数码管点亮情况
	MOV DX,APORT
	MOV AX,INIT
	OUT DX,AX
	MOV DX,CPORT
	MOV AL,TAB[BX]
	OUT DX,AX
	MOV DX,BPORT
	MOV AL,TAB[BP]
	OUT DX,AX
	CALL DELAY
	
	
;后半秒红绿灯以及数码管点亮情况(实现闪烁)
	;判断数码管如何闪烁
	CMP FLASH_7SEG,0 ;
	JL EWFALSH ;小于0代表东西闪烁
	CMP FLASH_7SEG,0
	JG SNFALSH ;大于0代表南北闪烁
	JMP NEXT

EWFALSH: ;东西方向的数码管闪烁
	MOV DX,BPORT
	MOV AX,0
	OUT DX,AX
	JMP NEXT

SNFALSH: ;南北方向的数码管闪烁
	MOV DX,CPORT
	MOV AX,0
	OUT DX,AX

NEXT:
	MOV AX,FLASH
	MOV DX,APORT
	OUT DX,AX
	CALL DELAY
	DEC BX
	DEC BP
	LOOP LOOPS
	
	POP BP
	POP DX
	POP CX
	POP BX
	RET
EXIT:
    MOV AH, 4CH
    INT 21H
CODE ENDS
     END START